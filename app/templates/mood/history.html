{% extends "body.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/mood.css') }}">
{% endblock %}

{% block content %}
<!-- Use semantic main tag for primary content -->
<main class="mood-container">
    <!-- ======== BACKGROUND ELEMENTS ======== -->
    <div class="led-bg" aria-hidden="true"></div>
    <div class="bg-gradient" aria-hidden="true"></div>

    <!-- ======== PAGE HEADER ======== -->
    <header class="page-header">
        <h1>Your Mood History</h1>
        <p class="subtitle">Track your emotional patterns over time</p>
    </header>
    
    <!-- ======== HISTORY CONTENT ======== -->
    <div class="history-container">
        {% if mood_entries %}
            <!-- Trend Charts -->
            <section class="history-section trend-charts">
                <h2>Mood Trends</h2>
                <div class="chart-card">
                    <div class="chart-tabs">
                        <button class="chart-tab active" data-period="week">Last Week</button>
                        <button class="chart-tab" data-period="month">Last Month</button>
                        <button class="chart-tab" data-period="year">Last Year</button>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="moodTrendChart"></canvas>
                    </div>
                    
                    <div class="chart-legend">
                        <div class="legend-item">
                            <span class="color-dot" style="background-color: rgba(255, 99, 132, 0.8);"></span>
                            <span>Energy</span>
                        </div>
                        <div class="legend-item">
                            <span class="color-dot" style="background-color: rgba(54, 162, 235, 0.8);"></span>
                            <span>Happiness</span>
                        </div>
                        <div class="legend-item">
                            <span class="color-dot" style="background-color: rgba(255, 206, 86, 0.8);"></span>
                            <span>Anxiety</span>
                        </div>
                        <div class="legend-item">
                            <span class="color-dot" style="background-color: rgba(75, 192, 192, 0.8);"></span>
                            <span>Stress</span>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Color Patterns -->
            <section class="history-section color-patterns">
                <h2>Your Color Patterns</h2>
                <div class="color-history-card">
                    <p class="section-intro">The colors you've used over time can reveal patterns in your emotional landscape. Here's how your color choices have evolved:</p>
                    
                    <div class="color-timeline">
                        {% for entry in mood_entries if entry.color_suggestion %}
                            <div class="color-point" style="background-color: #{{ entry.color_suggestion.primary_color }};" title="{{ entry.timestamp.strftime('%B %d, %Y') }}"></div>
                        {% endfor %}
                    </div>
                    
                    <div class="color-stats">
                        <h3>Your Top Colors</h3>
                        <div class="color-frequency">
                            <!-- This would be populated with actual data in a real implementation -->
                            <div class="color-item">
                                <div class="color-sample" style="background-color: #0066FF;"></div>
                                <div class="color-info">
                                    <span class="color-name">Calming Blue</span>
                                    <span class="color-percentage">35%</span>
                                </div>
                            </div>
                            <div class="color-item">
                                <div class="color-sample" style="background-color: #FFEB3B;"></div>
                                <div class="color-info">
                                    <span class="color-name">Happy Yellow</span>
                                    <span class="color-percentage">25%</span>
                                </div>
                            </div>
                            <div class="color-item">
                                <div class="color-sample" style="background-color: #4CAF50;"></div>
                                <div class="color-info">
                                    <span class="color-name">Focused Green</span>
                                    <span class="color-percentage">20%</span>
                                </div>
                            </div>
                            <div class="color-item">
                                <div class="color-sample" style="background-color: #9C27B0;"></div>
                                <div class="color-info">
                                    <span class="color-name">Creative Purple</span>
                                    <span class="color-percentage">15%</span>
                                </div>
                            </div>
                            <div class="color-item">
                                <div class="color-sample" style="background-color: #FF5500;"></div>
                                <div class="color-info">
                                    <span class="color-name">Energetic Orange</span>
                                    <span class="color-percentage">5%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Mood Log -->
            <section class="history-section mood-log">
                <h2>Mood Log</h2>
                <div class="mood-log-filters">
                    <input type="text" id="mood-search" placeholder="Search notes...">
                    <select id="mood-sort">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="highest-energy">Highest Energy</option>
                        <option value="lowest-energy">Lowest Energy</option>
                        <option value="happiest">Happiest</option>
                        <option value="least-happy">Least Happy</option>
                    </select>
                </div>
                
                <div class="mood-entries-list">
                    {% for entry in mood_entries %}
                    <div class="mood-entry-card">
                        <div class="entry-header">
                            <div class="entry-date">{{ entry.timestamp.strftime('%B %d, %Y') }}</div>
                            <div class="entry-time">{{ entry.timestamp.strftime('%I:%M %p') }}</div>
                        </div>
                        
                        <div class="entry-metrics">
                            <div class="mini-metric">
                                <span class="mini-label">Energy</span>
                                <div class="mini-bar">
                                    <div class="mini-fill" style="width: {{ entry.energy_level * 10 }}%"></div>
                                </div>
                                <span class="mini-value">{{ entry.energy_level }}/10</span>
                            </div>
                            
                            <div class="mini-metric">
                                <span class="mini-label">Happiness</span>
                                <div class="mini-bar">
                                    <div class="mini-fill" style="width: {{ entry.happiness * 10 }}%"></div>
                                </div>
                                <span class="mini-value">{{ entry.happiness }}/10</span>
                            </div>
                            
                            <div class="mini-metric">
                                <span class="mini-label">Anxiety</span>
                                <div class="mini-bar">
                                    <div class="mini-fill" style="width: {{ entry.anxiety * 10 }}%"></div>
                                </div>
                                <span class="mini-value">{{ entry.anxiety }}/10</span>
                            </div>
                            
                            <div class="mini-metric">
                                <span class="mini-label">Stress</span>
                                <div class="mini-bar">
                                    <div class="mini-fill" style="width: {{ entry.stress * 10 }}%"></div>
                                </div>
                                <span class="mini-value">{{ entry.stress }}/10</span>
                            </div>
                        </div>
                        
                        {% if entry.notes %}
                        <div class="entry-notes">
                            <p>{{ entry.notes }}</p>
                        </div>
                        {% endif %}
                        
                        {% if entry.color_suggestion %}
                        <div class="entry-colors">
                            <div class="mini-swatch" style="background-color: #{{ entry.color_suggestion.primary_color }};"></div>
                            <div class="mini-swatch" style="background-color: #{{ entry.color_suggestion.secondary_color }};"></div>
                            <div class="mini-swatch" style="background-color: #{{ entry.color_suggestion.accent_color }};"></div>
                        </div>
                        {% endif %}
                        
                        <div class="entry-actions">
                            <a href="{{ url_for('mood.results', mood_entry_id=entry.id) }}" class="btn btn-sm">View Details</a>
                            {% if entry.color_suggestion %}
                            <button class="btn btn-sm btn-primary apply-colors" data-suggestion-id="{{ entry.color_suggestion.id }}">Apply Colors</button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination (for longer histories) -->
                <div class="pagination">
                    <button class="page-btn" disabled>&laquo; Previous</button>
                    <span class="page-indicator">Page 1 of 1</span>
                    <button class="page-btn" disabled>Next &raquo;</button>
                </div>
            </section>
            
        {% else %}
            <!-- Empty State -->
            <div class="empty-state">
                <h2>No Mood History Yet</h2>
                <p>You haven't recorded any mood entries. Take your first mood survey to start tracking your emotional patterns!</p>
                <a href="{{ url_for('mood.survey') }}" class="btn btn-primary">Take Mood Survey</a>
            </div>
        {% endif %}
        
        <!-- Navigation Buttons -->
        <div class="navigation-buttons">
            <a href="{{ url_for('mood.index') }}" class="btn btn-secondary">Back to Dashboard</a>
            <a href="{{ url_for('mood.survey') }}" class="btn btn-primary">Record New Mood</a>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Prepare data for the trend chart
        const moodData = {
            timestamps: [
                {% for entry in mood_entries %}
                '{{ entry.timestamp.strftime("%Y-%m-%d %H:%M:%S") }}',
                {% endfor %}
            ],
            energy: [
                {% for entry in mood_entries %}
                {{ entry.energy_level }},
                {% endfor %}
            ],
            happiness: [
                {% for entry in mood_entries %}
                {{ entry.happiness }},
                {% endfor %}
            ],
            anxiety: [
                {% for entry in mood_entries %}
                {{ entry.anxiety }},
                {% endfor %}
            ],
            stress: [
                {% for entry in mood_entries %}
                {{ entry.stress }},
                {% endfor %}
            ]
        };
        
        // Reverse arrays so oldest entries are first (left side of chart)
        moodData.timestamps.reverse();
        moodData.energy.reverse();
        moodData.happiness.reverse();
        moodData.anxiety.reverse();
        moodData.stress.reverse();
        
        // Initialize the trend chart
        const ctx = document.getElementById('moodTrendChart').getContext('2d');
        const moodChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: moodData.timestamps.map(timestamp => {
                    const date = new Date(timestamp);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }),
                datasets: [
                    {
                        label: 'Energy',
                        data: moodData.energy,
                        borderColor: 'rgba(255, 99, 132, 0.8)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 3
                    },
                    {
                        label: 'Happiness',
                        data: moodData.happiness,
                        borderColor: 'rgba(54, 162, 235, 0.8)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 3
                    },
                    {
                        label: 'Anxiety',
                        data: moodData.anxiety,
                        borderColor: 'rgba(255, 206, 86, 0.8)',
                        backgroundColor: 'rgba(255, 206, 86, 0.1)',
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 3
                    },
                    {
                        label: 'Stress',
                        data: moodData.stress,
                        borderColor: 'rgba(75, 192, 192, 0.8)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        grid: {
                            display: true,
                            color: 'rgba(200, 200, 200, 0.2)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false,
                        position: 'top',
                    }
                },
                elements: {
                    line: {
                        fill: true
                    }
                }
            }
        });
        
        // Chart period tabs functionality
        const chartTabs = document.querySelectorAll('.chart-tab');
        chartTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Update active tab
                chartTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Get period
                const period = this.getAttribute('data-period');
                
                // Filter data based on period
                let filteredData;
                if (period === 'week') {
                    // Last 7 entries or all if less than 7
                    const count = Math.min(7, moodData.timestamps.length);
                    filteredData = filterLastN(moodData, count);
                } else if (period === 'month') {
                    // Last 30 entries or all if less than 30
                    const count = Math.min(30, moodData.timestamps.length);
                    filteredData = filterLastN(moodData, count);
                } else {
                    // All data
                    filteredData = moodData;
                }
                
                // Update chart data
                moodChart.data.labels = filteredData.timestamps.map(timestamp => {
                    const date = new Date(timestamp);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                moodChart.data.datasets[0].data = filteredData.energy;
                moodChart.data.datasets[1].data = filteredData.happiness;
                moodChart.data.datasets[2].data = filteredData.anxiety;
                moodChart.data.datasets[3].data = filteredData.stress;
                
                // Update chart
                moodChart.update();
            });
        });
        
        function filterLastN(data, n) {
            // Get the last N entries
            const startIndex = Math.max(0, data.timestamps.length - n);
            return {
                timestamps: data.timestamps.slice(startIndex),
                energy: data.energy.slice(startIndex),
                happiness: data.happiness.slice(startIndex),
                anxiety: data.anxiety.slice(startIndex),
                stress: data.stress.slice(startIndex)
            };
        }
        
        // Apply colors button functionality
        const applyButtons = document.querySelectorAll('.apply-colors');
        applyButtons.forEach(button => {
            button.addEventListener('click', function() {
                const suggestionId = this.getAttribute('data-suggestion-id');
                applySuggestion(suggestionId, this);
            });
        });
        
        function applySuggestion(suggestionId, button) {
            // Show loading state
            const originalText = button.textContent;
            button.textContent = 'Applying...';
            button.disabled = true;
            
            // Send AJAX request to apply colors
            fetch(`/mood/apply/${suggestionId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Apply the colors to the WLED controller
                    applyColorsToWLED(data.colors);
                    
                    // Update button
                    button.textContent = 'Applied!';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 2000);
                } else {
                    button.textContent = 'Error';
                    console.error('Failed to apply colors:', data.error);
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                button.textContent = 'Error';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 2000);
            });
        }
        
        function applyColorsToWLED(colors) {
            // Get WLED IP from local storage
            const wledIP = localStorage.getItem('wledIP');
            if (!wledIP) {
                alert('WLED address not found. Please set up your WLED connection first.');
                return;
            }
            
            // This function would integrate with the existing WLED connection code
            console.log('Applying colors to WLED at', wledIP, colors);
            
            // Redirect to the RGB page with the color data
            const rgbUrl = `/rgb?autoload=true&primary=${colors.primary}&secondary=${colors.secondary}&accent=${colors.accent}&brightness=${colors.brightness}&effect=${colors.effect}`;
            window.location.href = rgbUrl;
        }
        
        // Search and filter functionality
        const searchInput = document.getElementById('mood-search');
        const sortSelect = document.getElementById('mood-sort');
        const moodEntries = document.querySelectorAll('.mood-entry-card');
        
        if (searchInput) {
            searchInput.addEventListener('input', filterEntries);
        }
        
        if (sortSelect) {
            sortSelect.addEventListener('change', sortEntries);
        }
        
        function filterEntries() {
            const searchTerm = searchInput.value.toLowerCase();
            
            moodEntries.forEach(entry => {
                const notes = entry.querySelector('.entry-notes');
                if (!notes) {
                    // If no notes, show entry if search is empty
                    entry.style.display = searchTerm === '' ? 'block' : 'none';
                    return;
                }
                
                const noteText = notes.textContent.toLowerCase();
                if (noteText.includes(searchTerm)) {
                    entry.style.display = 'block';
                } else {
                    entry.style.display = 'none';
                }
            });
        }
        
        function sortEntries() {
            const sortValue = sortSelect.value;
            const entriesContainer = document.querySelector('.mood-entries-list');
            const entriesArray = Array.from(moodEntries);
            
            // Sort entries based on selected option
            entriesArray.sort((a, b) => {
                if (sortValue === 'newest') {
                    // Compare date strings (assumes format is consistent)
                    const dateA = a.querySelector('.entry-date').textContent;
                    const dateB = b.querySelector('.entry-date').textContent;
                    return new Date(dateB) - new Date(dateA);
                } else if (sortValue === 'oldest') {
                    const dateA = a.querySelector('.entry-date').textContent;
                    const dateB = b.querySelector('.entry-date').textContent;
                    return new Date(dateA) - new Date(dateB);
                } else if (sortValue === 'highest-energy') {
                    const energyA = parseInt(a.querySelector('.mini-value').textContent);
                    const energyB = parseInt(b.querySelector('.mini-value').textContent);
                    return energyB - energyA;
                } else if (sortValue === 'lowest-energy') {
                    const energyA = parseInt(a.querySelector('.mini-value').textContent);
                    const energyB = parseInt(b.querySelector('.mini-value').textContent);
                    return energyA - energyB;
                } else if (sortValue === 'happiest') {
                    // Get the second mini-value (happiness)
                    const happinessA = parseInt(a.querySelectorAll('.mini-value')[1].textContent);
                    const happinessB = parseInt(b.querySelectorAll('.mini-value')[1].textContent);
                    return happinessB - happinessA;
                } else if (sortValue === 'least-happy') {
                    const happinessA = parseInt(a.querySelectorAll('.mini-value')[1].textContent);
                    const happinessB = parseInt(b.querySelectorAll('.mini-value')[1].textContent);
                    return happinessA - happinessB;
                }
                return 0;
            });
            
            // Remove all entries
            entriesArray.forEach(entry => {
                entriesContainer.removeChild(entry);
            });
            
            // Add sorted entries back
            entriesArray.forEach(entry => {
                entriesContainer.appendChild(entry);
            });
        }
    });
</script>
{% endblock %}