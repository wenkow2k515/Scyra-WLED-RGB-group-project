<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RGB Editor</title>
    <script src="/static/js/LEDgrid.js" defer></script>
    <link rel="stylesheet" href="/static/css/rgb.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <script>
        // Define global variables that LEDgrid.js can access
        window.preset_name = {% if preset_name %}{{ preset_name|tojson }}{% else %}null{% endif %};
        window.preset_id = {% if preset_id %}{{ preset_id|tojson }}{% else %}null{% endif %};
        window.preset_data = {% if preset_data %}{{ preset_data|tojson }}{% else %}null{% endif %};
        window.view_mode = {% if view_mode %}{{ view_mode|tojson }}{% else %}false{% endif %};
        window.edit_mode = {% if edit_mode %}{{ edit_mode|tojson }}{% else %}false{% endif %};
    </script>
    <style>
      body, html {
          margin: 0;
          padding: 0;
          height: 100%;
          font-family: Arial, sans-serif;
      }
      /* Center a single pane */
      .setup-container {
        position: fixed;
        top: 4rem; /* Adjust this to match the height of the navbar */
        left: 0;
        width: 100vw;
        height: calc(100vh - 4rem); /* Adjust to fill remaining space below navbar */
        display: flex;
        justify-content: center;
        align-items: center;
        background: white;
        z-index: 999;
      }

      .setup-pane {
          width: 100%;
          max-width: 400px;
          padding: 2rem;
          box-sizing: border-box;
          text-align: center;
      }
      .setup-pane h2 {
          margin-bottom: 1rem;
      }
      .setup-pane input,
      .setup-pane button {
          margin-top: 0.5rem;
          padding: 0.5rem;
          font-size: 1rem;
          width: 100%;
          max-width: 300px;
      }
      .setup-pane p {
          margin-top: 1rem;
          color: #555;
      }
      .hidden {
          display: none;
      }
      #editor {
          padding: 2rem;
          max-width: 1200px;
          margin: 0 auto;
      }

      .cell.selected::before {
          content: "âœ“";
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-size: 24px;
          color: white;
          text-shadow: 0 0 3px black, 0 0 3px black, 0 0 3px black;
          pointer-events: none;
      }
      .cell {
          position: relative;  /* Needed for absolute positioning of the checkmark */
          width: 50px;
          height: 50px;
          border: 2px solid #ddd;
          cursor: pointer;
          transition: all 0.2s;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      .cell.selected {
          border-color: #000;
          transform: scale(1.1);
      }
      #output-container {
          margin-top: 1rem;
          background: #eee;
          border-radius: 8px;
          padding: 1rem;
          max-height: 300px;
          overflow-y: auto;
      }
      #output {
          white-space: pre-wrap;
          word-wrap: break-word;
          margin: 0;
      }
      .json-controls {
          display: flex;
          gap: 10px;
          margin-top: 10px;
      }
      .save-btn {
          background-color: #4a90e2;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 4px;
          cursor: pointer;
          transition: background-color 0.3s;
          font-weight: bold;
      }
      .save-btn:hover {
          background-color: #3a80d2;
      }
      .save-preset-container {
          display: flex;
          align-items: center;
          gap: 15px;
          margin: 1rem 0;
      }
      .public-toggle {
          display: flex;
          align-items: center;
          gap: 5px;
      }
      .tooltip {
          cursor: help;
          font-size: 12px;
          background-color: #f0f0f0;
          border-radius: 50%;
          width: 16px;
          height: 16px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
      }
      /* Style for feedback messages */
      .feedback-message {
          padding: 10px;
          margin-top: 10px;
          border-radius: 4px;
          display: none;
      }
      .success-message {
          background-color: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }
      .error-message {
          background-color: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }
    </style>
</head>
{% if view_mode %}
<style>
    #view-flag {
        display: none;
    }
</style>
{% endif %}

{% extends "body.html" %}

{% block content %}

<!-- Setup Phase: single centered pane -->
<div id="setup" class="setup-container">
  <div class="setup-pane">
    <h2>Connect to Your WLED Device</h2>
    <p>Enter the IP address of your WLED device</p>
    <input id="wledAddress" placeholder="192.168.1.x" autocomplete="off">
    <p style="margin-top:0.5rem;font-size:0.8rem;color:#777">Hint: Use "000" for debug mode</p>
    <button id="checkBtn" disabled>Connect</button>
    <div id="checkMsg" style="margin-top:0.5rem;height:1.5em"></div>
  </div>
</div>

<!-- Editor Phase -->
<div id="editor" class="hidden">
  <h2>Build Your Preset</h2>

  <div class="color-grid" id="grid"></div>

  <div id = "view-flag">
  <div style="margin-top:1rem;">
    <label for="colorPicker">Pick Color:</label>
    <input type="color" id="colorPicker" value="#ffffff">

    <label for="briSlider" style="margin-left:1rem;">Brightness:</label>
    <input type="range" id="briSlider" min="0" max="255" value="255">
    <span id="briValue">255</span>

    
    <div style="margin-top:1rem;">
      <button id="applyColor">Apply Color</button>
      <button id="defaultBtn">Set Default (50% Blue)</button>
      <button id="createBtn">Create JSON</button>
    </div>
  </div>

  {% if current_user.is_authenticated %}
  <div class="save-preset-container" style="margin-top:1rem;">
    <button id="saveToAccount" class="save-btn">Save to Account</button>
    <div class="public-toggle">
      <input type="checkbox" id="isPublic" name="isPublic">
      <label for="isPublic">Make preset public</label>
      <span class="tooltip" title="Public presets can be viewed by all users">?</span>
    </div>
  </div>
  {% endif %}

  <div id="output-container" class="hidden">
    <h3>Generated Preset</h3>
    <pre id="output"></pre>
    <div class="json-controls">
      <button id="copyJson">Copy to Clipboard</button>
      <button id="sendToWled">Send to WLED</button>
    </div>
  </div>
  </div>

  <div id="saveMessage" class="feedback-message"></div>
</div>

{% endblock %}
